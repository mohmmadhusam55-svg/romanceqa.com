// Language translations
const translations = {
    en: {
        nav: {
            home: "Home",
            about: "About Us",
            products: "Products",
            services: "Services",
            contact: "Contact"
        },
        hero: {
            title: "retail market",
            subtitle: "Your trusted partner in quality products and exceptional services",
            explore: "Explore Products",
            contact: "Get in Touch"
        },
        about: {
            title: "About Us",
            description: "Romance Trading is a leading company dedicated to providing high-quality products and exceptional services to our valued customers. With years of experience and a commitment to excellence, we have built a reputation for reliability and innovation.",
            years: "Years Experience",
            clients: "Happy Clients",
            products: "Products",
            box1: {
                title: "Who We Are?",
                description: "Welcome to Romance Trading. With over 30 years of experience, we have built strong partnerships with international and local manufacturers, establishing a strong presence in Qatar's key markets. We specialize in disposables, daily consumables, kitchen and home appliances, storage goods, healthcare products, and cosmetics. By importing high-quality products from various countries, we meet the diverse needs of our customers across Qatar. In addition to trading, we own and operate several brands, all committed to excellence and innovation. At Romance Trading, your satisfaction is our priority. Thank you for choosing us as your trusted partner."
            },
            box2: {
                title: "Our Vision",
                description: "To be the leading provider of essential consumer goods, daily consumables, cosmetics and healthcare products in the region, known for quality, innovation and customer satisfaction."
            },
            box3: {
                title: "Collaborate With Us",
                description: "We are open to partnering with companies outside Qatar to bring high quality products to Doha. If you are interested in partnering with us, please contact us."
            }
        },
        products: {
            title: "Our Products",
            enjoy: "enjoy your shopping with us , contact us for more infroamtion",
            retail: "Retail",
            wholesale: "Wholesale",
            product1: {
                title: "Premium Product 1",
                description: "High-quality product designed for excellence and durability."
            },
            product2: {
                title: "Innovative Product 2",
                description: "Cutting-edge technology meets superior craftsmanship."
            },
            product3: {
                title: "Quality Product 3",
                description: "Reliable and efficient solution for your needs."
            }
        },
        services: {
            title: "Our Services",
            service1: {
                title: "Technical Support",
                description: "24/7 technical support and maintenance services."
            },
            service2: {
                title: "Fast Delivery",
                description: "Quick and reliable delivery to your doorstep."
            },
            service3: {
                title: "Customer Care",
                description: "Dedicated customer care and consultation services."
            }
        },
        contact: {
            title: "Contact Us",
            address: {
                title: "Address",
                text: "Doha, Qatar"
            },
            phone: {
                title: "Phone",
                number: "00974 55033715"
            },
            email: {
                title: "Email",
                address: "info@romanceqa.com"
            },
            form: {
                name: "Your Name",
                email: "Your Email",
                message: "Your Message",
                send: "Send Message"
            },
            send: "Send Message",
            mapLink: "View on Google Maps"
        },
        footer: {
            company: "Romance Trading",
            description: "Your trusted partner in quality and innovation.",
            quick: "Quick Links",
            social: "Follow Us",
            copyright: "&copy; 2024 Romance Trading. All rights reserved."
        },
        search: {
            placeholder: "Search...",
            title: "Search Products"
        },
        shop: {
            title: "Shop",
            collections: "Collections",
            filterBy: "Filter by",
            availability: "Availability",
            inStock: "In stock",
            outOfStock: "Out of stock",
            price: "Price",
            priceFrom: "From",
            priceTo: "To",
            to: "to",
            highestPrice: "Highest price: ",
            sortBy: "Sort by",
            sort: {
                featured: "Featured",
                bestSelling: "Best selling",
                alphaAZ: "Alphabetically, A-Z",
                alphaZA: "Alphabetically, Z-A",
                priceLowHigh: "Price, low to high",
                priceHighLow: "Price, high to low",
                dateOldNew: "Date, old to new",
                dateNewOld: "Date, new to old"
            },
            clearAll: "Clear all",
            apply: "Apply",
            productsCount: " products",
            paginationInfo: " / ",
            loadMore: "Load More Products",
            allProducts: "All Products",
            noProductsFound: "No products found",
            tryAdjustingFilters: "Try adjusting your search or filter criteria",
            addToCart: "Add to Cart",
            added: "Added"
        },
        cart: {
            title: "Shopping Cart",
            total: "Total: ",
            viewCart: "View Cart",
            clearCart: "Clear Cart",
            checkout: "Checkout"
        },
        notification: {
            itemAdded: "Item added to your cart",
            viewCart: "View cart",
            checkout: "Check out",
            continueShopping: "Continue shopping"
        }
    },
    ar: {
        nav: {
            home: "الرئيسية",
            about: "من نحن",
            products: "المنتجات",
            services: "الخدمات",
            contact: "اتصل بنا"
        },
        search: {
            placeholder: "بحث...",
            title: "البحث عن منتجات"
        },
        hero: {
            title: "مرحباً بكم في رومانس للتجارة",
            subtitle: "شريككم الموثوق في المنتجات عالية الجودة والخدمات المتميزة",
            explore: "استكشف المنتجات",
            contact: "تواصل معنا"
        },
        about: {
            title: "من نحن",
            description: "رومانس للتجارة هي شركة رائدة متخصصة في تقديم منتجات عالية الجودة وخدمات متميزة لعملائنا الكرام. مع سنوات من الخبرة والتزام بالتميز، بنينا سمعة في الموثوقية والابتكار.",
            years: "سنوات الخبرة",
            clients: "عميل سعيد",
            products: "منتج",
            box1: {
                title: "من نحن؟",
                description: "مرحبًا بكم في رومانس للتجارة. مع أكثر من 30 عامًا من الخبرة، قمنا ببناء شراكات قوية مع الشركات المصنعة الدولية والمحلية، مما أدى إلى ترسيخ وجود قوي في الأسواق الرئيسية في قطر. نحن متخصصون في المواد التي تستخدم لمرة واحدة، والمواد الاستهلاكية اليومية، وأدوات المطبخ والأجهزة المنزلية، وسلع التخزين، ومنتجات الرعاية الصحية، ومستحضرات التجميل. من خلال استيراد منتجات عالية الجودة من مختلف البلدان، فإننا نلبي الاحتياجات المتنوعة لعملائنا في جميع أنحاء قطر. بالإضافة إلى التجارة، نحن نملك وندير العديد من العلامات التجارية، وكلها ملتزمة بالتميز والابتكار. في رومانس للتجارة، رضاكم هو أولويتنا. شكرًا لاختياركم لنا كشريك موثوق به."
            },
            box2: {
                title: "رؤيتنا",
                description: "أن نكون المزود الرائد للسلع الاستهلاكية الأساسية والمواد الاستهلاكية اليومية ومستحضرات التجميل ومنتجات الرعاية الصحية في المنطقة، والمعروفين بالجودة والابتكار ورضا العملاء."
            },
            box3: {
                title: "تعاون معنا",
                description: "نحن منفتحون على الشراكة مع الشركات خارج قطر لجلب منتجات عالية الجودة إلى الدوحة. إذا كنت مهتمًا بالشراكة معنا، فيرجى الاتصال بنا."
            }
        },
        products: {
            title: "منتجاتنا",
            enjoy: "استمتع بالتسوق معنا، اتصل بنا لمزيد من المعلومات",
            retail: "تجزئة",
            wholesale: "جملة",
            product1: {
                title: "المنتج المميز 1",
                description: "منتج عالي الجودة مصمم للتميز والمتانة."
            },
            product2: {
                title: "المنتج المبتكر 2",
                description: "التكنولوجيا المتطورة تلتقي بالحرفية المتفوقة."
            },
            product3: {
                title: "المنتج عالي الجودة 3",
                description: "حل موثوق وفعال لاحتياجاتكم."
            }
        },
        services: {
            title: "خدماتنا",
            service1: {
                title: "الدعم الفني",
                description: "خدمات الدعم الفني والصيانة على مدار الساعة."
            },
            service2: {
                title: "التوصيل السريع",
                description: "توصيل سريع وموثوق إلى باب منزلكم."
            },
            service3: {
                title: "رعاية العملاء",
                description: "خدمات رعاية العملاء والاستشارات المخصصة."
            }
        },
        contact: {
            title: "اتصل بنا",
            address: {
                title: "العنوان",
                text: "الدوحة، قطر"
            },
            phone: {
                title: "الهاتف",
                number: "00974 55033715"
            },
            email: {
                title: "البريد الإلكتروني",
                address: "info@romanceqa.com"
            },
            form: {
                name: "اسمك",
                email: "بريدك الإلكتروني",
                message: "رسالتك",
                send: "إرسال"
            },
            send: "إرسال الرسالة",
            mapLink: "عرض على خرائط جوجل"
        },
        footer: {
            company: "رومانس للتجارة",
            description: "شريككم الموثوق في الجودة والابتكار.",
            quick: "روابط سريعة",
            social: "تابعونا",
            copyright: "&copy; 2024 رومانس للتجارة. كل الحقوق محفوظة."
        },
        shop: {
            title: "المتجر",
            collections: "المجموعات",
            filterBy: "تصفية حسب",
            availability: "التوفر",
            inStock: "متوفر",
            outOfStock: "غير متوفر",
            price: "السعر",
            priceFrom: "من",
            priceTo: "إلى",
            to: "إلى",
            highestPrice: "أعلى سعر: ",
            sortBy: "ترتيب حسب",
            sort: {
                featured: "مميزة",
                bestSelling: "الأكثر مبيعًا",
                alphaAZ: "أبجديًا، أ-ي",
                alphaZA: "أبجديًا، ي-أ",
                priceLowHigh: "السعر، من الأقل إلى الأعلى",
                priceHighLow: "السعر، من الأعلى إلى الأقل",
                dateOldNew: "التاريخ، من القديم إلى الجديد",
                dateNewOld: "التاريخ، من الجديد إلى القديم"
            },
            clearAll: "مسح الكل",
            apply: "تطبيق",
            productsCount: " منتجات",
            paginationInfo: " / ",
            loadMore: "تحميل المزيد من المنتجات",
            allProducts: "كل المنتجات",
            noProductsFound: "لم يتم العثور على منتجات",
            tryAdjustingFilters: "حاول تعديل معايير البحث أو التصفية",
            addToCart: "أضف إلى السلة",
            added: "تمت الإضافة"
        },
        cart: {
            title: "عربة التسوق",
            total: "المجموع: ",
            viewCart: "عرض العربة",
            clearCart: "إفراغ العربة",
            checkout: "الدفع"
        },
        notification: {
            itemAdded: "تمت إضافة المنتج إلى عربة التسوق الخاصة بك",
            viewCart: "عرض العربة",
            checkout: "الدفع",
            continueShopping: "متابعة التسوق"
        }
    },
    tr: {
        nav: {
            home: "Ana Sayfa",
            about: "Hakkımızda",
            products: "Ürünler",
            services: "Hizmetler",
            contact: "İletişim"
        },
        hero: {
            title: "retail market",
            subtitle: "Kaliteli ürünler ve olağanüstü hizmetlerde güvenilir ortağınız",
            explore: "Ürünleri Keşfet",
            contact: "İletişime Geç"
        },
        about: {
            title: "Hakkımızda",
            description: "Romance Trading, değerli müşterilerimize yüksek kaliteli ürünler ve olağanüstü hizmetler sunmaya adanmış önde gelen bir şirkettir. Yılların deneyimi ve mükemmellik taahhüdü ile güvenilirlik ve yenilik konusunda bir itibar inşa ettik.",
            years: "Yıl Deneyim",
            clients: "Mutlu Müşteri",
            products: "Ürün",
            box1: {
                title: "Biz Kimiz?",
                description: "Romance Trading'e hoş geldiniz. 30 yılı aşkın tecrübemizle uluslararası ve yerel üreticilerle güçlü ortaklıklar kurarak Katar'ın kilit pazarlarında güçlü bir yer edindik. Tek kullanımlık ürünler, günlük sarf malzemeleri, mutfak ve ev aletleri, depolama ürünleri, sağlık ürünleri ve kozmetik alanlarında uzmanız. Çeşitli ülkelerden yüksek kaliteli ürünler ithal ederek Katar'daki müşterilerimizin farklı ihtiyaçlarını karşılıyoruz. Ticarete ek olarak, tamamı mükemmellik ve yeniliğe kendini adamış birkaç markanın sahibi ve işletmecisiyiz. Romance Trading'de memnuniyetiniz bizim önceliğinizdir. Bizi güvenilir ortağınız olarak seçtiğiniz için teşekkür ederiz."
            },
            box2: {
                title: "Vizyonumuz",
                description: "Bölgede kalite, yenilik ve müşteri memnuniyeti ile tanınan temel tüketim malları, günlük sarf malzemeleri, kozmetik ve sağlık ürünlerinin lider sağlayıcısı olmak."
            },
            box3: {
                title: "Bizimle İşbirliği Yapın",
                description: "Doha'ya yüksek kaliteli ürünler getirmek için Katar dışındaki şirketlerle ortaklık kurmaya açığız. Bizimle ortaklık yapmak isterseniz, lütfen bizimle iletişime geçin."
            }
        },
        products: {
            title: "Ürünlerimiz",
            enjoy: "Bizimle alışverişin tadını çıkarın, daha fazla bilgi için bize ulaşın",
            retail: "Perakende",
            wholesale: "Toptan",
            product1: {
                title: "Premium Ürün 1",
                description: "Mükemmellik ve dayanıklılık için tasarlanmış yüksek kaliteli ürün."
            },
            product2: {
                title: "Yenilikçi Ürün 2",
                description: "En son teknoloji üstün işçilik ile buluşuyor."
            },
            product3: {
                title: "Kaliteli Ürün 3",
                description: "İhtiyaçlarınız için güvenilir ve verimli çözüm."
            }
        },
        services: {
            title: "Hizmetlerimiz",
            service1: {
                title: "Teknik Destek",
                description: "24/7 teknik destek ve bakım hizmetleri."
            },
            service2: {
                title: "Hızlı Teslimat",
                description: "Kapınıza hızlı ve güvenilir teslimat."
            },
            service3: {
                title: "Müşteri Hizmetleri",
                description: "Özel müşteri hizmetleri ve danışmanlık hizmetleri."
            }
        },
        contact: {
            title: "İletişim",
            address: {
                title: "Adres",
                text: "Doha, Katar"
            },
            phone: {
                title: "Telefon",
                number: "00974 55033715"
            },
            email: {
                title: "E-posta",
                address: "info@romanceqa.com"
            },
            form: {
                name: "Adınız",
                email: "E-postanız",
                message: "Mesajınız",
                send: "Gönder"
            },
            send: "Mesaj Gönder",
            mapLink: "Google Haritalar'da Görüntüle"
        },
        footer: {
            company: "Romance Trading",
            description: "Kalite ve yenilikte güvenilir ortağınız.",
            quick: "Hızlı Bağlantılar",
            social: "Bizi Takip Edin",
            copyright: "&copy; 2024 Romance Trading. Tüm hakları saklıdır."
        },
        search: {
            placeholder: "Ürünleri ara...",
            title: "Ürün Ara"
        },
        shop: {
            title: "Mağaza",
            collections: "Koleksiyonlar",
            filterBy: "Filtrele",
            availability: "Stok durumu",
            inStock: "Stokta",
            outOfStock: "Stokta yok",
            price: "Fiyat",
            priceFrom: "Min",
            priceTo: "Max",
            to: "ile",
            highestPrice: "En yüksek fiyat: ",
            sortBy: "Sırala",
            sort: {
                featured: "Öne çıkanlar",
                bestSelling: "En çok satanlar",
                alphaAZ: "Alfabetik, A-Z",
                alphaZA: "Alfabetik, Z-A",
                priceLowHigh: "Fiyat, düşükten yükseğe",
                priceHighLow: "Fiyat, yüksekten düşüğe",
                dateOldNew: "Tarih, eskiden yeniye",
                dateNewOld: "Tarih, yeniden eskiye"
            },
            clearAll: "Tümünü temizle",
            apply: "Uygula",
            productsCount: " ürün",
            paginationInfo: " / ",
            loadMore: "Daha Fazla Ürün Yükle",
            allProducts: "Tüm Ürünler",
            noProductsFound: "Ürün bulunamadı",
            tryAdjustingFilters: "Aramanızı veya filtre kriterlerinizi değiştirmeyi deneyin",
            addToCart: "Sepete Ekle",
            added: "Eklendi"
        },
        cart: {
            title: "Alışveriş Sepeti",
            total: "Toplam: ",
            viewCart: "Sepeti Görüntüle",
            clearCart: "Sepeti Temizle",
            checkout: "Ödeme"
        },
        notification: {
            itemAdded: "Ürün sepetinize eklendi",
            viewCart: "Sepeti görüntüle",
            checkout: "Ödeme",
            continueShopping: "Alışverişe devam et"
        }
    }
};

// Current language
let currentLang = 'en';

// DOM elements
const languageButtons = document.querySelectorAll('.lang-btn');
const earth = document.querySelector('.earth');
const languageOptions = document.querySelector('.language-options');
// const hamburger = document.querySelector('.hamburger');
// const navMenu = document.querySelector('.nav-menu');
const contactForm = document.querySelector('.contact-form');
const statNumbers = document.querySelectorAll('.stat-number');

// Initialize the website
document.addEventListener('DOMContentLoaded', function() {
    initializeWebsite();
    setupEventListeners();
    animateOnScroll();
    animateStats();
});

// Initialize website functionality
function initializeWebsite() {
    // Set initial language
    setLanguage(currentLang);
    
    // Add loading animation to elements
    document.querySelectorAll('.product-card, .service-card, .stat-item').forEach(el => {
        el.classList.add('loading');
    });
    
    // Trigger loading animation
    setTimeout(() => {
        document.querySelectorAll('.loading').forEach(el => {
            el.classList.add('loaded');
        });
    }, 500);
}

// Setup event listeners
function setupEventListeners() {
    // Language switching
    languageButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const lang = this.dataset.lang;
            setLanguage(lang);
            
            // Update active state
            languageButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Animate earth
            animateEarth();
        });
    });
    
    // Earth hover effects
    earth.addEventListener('mouseenter', function() {
        this.style.animationPlayState = 'paused';
        this.style.transform = 'scale(1.2) rotate(180deg)';
    });
    
    earth.addEventListener('mouseleave', function() {
        this.style.animationPlayState = 'running';
        this.style.transform = 'scale(1)';
    });
    
    // Mobile menu
    // hamburger.addEventListener('click', function() {
    //     navMenu.classList.toggle('active');
    //     this.classList.toggle('active');
    // });
    
    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Close mobile menu if open
                // navMenu.classList.remove('active');
                // hamburger.classList.remove('active');
            }
        });
    });
    
    // Contact form submission
    if(contactForm) {
        contactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleFormSubmission();
        });
    }
    
    // Add hover effects to buttons
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Add ripple effect to buttons
    document.querySelectorAll('.ripple-effect').forEach(btn => {
        btn.addEventListener('click', createRipple);
    });
}

// Set language and update content
function setLanguage(lang) {
    currentLang = lang;
    document.documentElement.setAttribute('data-lang', lang);

    // Update all translatable elements
    document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.dataset.langKey;
        const translation = getTranslation(key, lang);
        if (translation) {
            if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                element.setAttribute('placeholder', translation);
            } else {
                element.textContent = translation;
            }
        }
    });

    // Update page title
    document.title = `Romance Trading - ${translations[lang].nav.home}`;

    // Add language change animation
    document.body.style.opacity = '0.8';
    setTimeout(() => {
        document.body.style.opacity = '1';
    }, 200);

    // Update flag on the main language toggle button
    const langToggleBtn = document.querySelector('.lang-btn');
    if (langToggleBtn) {
        // Remove existing flag classes
        langToggleBtn.classList.remove('flag-en', 'flag-ar', 'flag-tr');
        // Add the new flag class
        langToggleBtn.classList.add(`flag-${lang}`);
        // Update the text content to only show the dropdown arrow
        langToggleBtn.innerHTML = ' ▾';
    }
}

// Get translation by key
function getTranslation(key, lang) {
    const keys = key.split('.');
    let value = translations[lang];
    
    for (const k of keys) {
        if (value && value[k]) {
            value = value[k];
        } else {
            return null;
        }
    }
    
    return value;
}

// Animate earth when language changes
function animateEarth() {
    if(!earth) return;
    earth.style.animation = 'none';
    earth.offsetHeight; // Trigger reflow
    earth.style.animation = 'rotate 20s linear infinite';
    
    // Add extra rotation effect
    earth.style.transform = 'scale(1.3) rotate(720deg)';
    setTimeout(() => {
        earth.style.transform = 'scale(1)';
    }, 600);
}

// Animate stats on scroll
function animateStats() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const target = entry.target;
                const count = parseInt(target.dataset.count);
                animateNumber(target, count);
                observer.unobserve(target);
            }
        });
    });
    
    statNumbers.forEach(stat => {
        observer.observe(stat);
    });
}

// --- New language-bar initialization (for header language bar) ---
document.addEventListener('DOMContentLoaded', function() {
    // Language buttons may exist in the language bar; re-query to ensure they are bound
    const langBtns = document.querySelectorAll('.language-bar .lang-btn');
    const globe = document.querySelector('.language-bar .earth');

    if (langBtns.length) {
        langBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const lang = this.dataset.lang;
                setLanguage(lang);
                // update active state for language bar buttons
                langBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                // animate globe
                if (globe) animateEarth();
            });
        });
    }

    if (globe) {
        globe.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.12) rotate(24deg)';
        });
        globe.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1) rotate(0deg)';
        });
        globe.addEventListener('click', function() {
            // quick spin on click
            animateEarth();
        });
    }
    // Header language toggle - let CSS hover handle the dropdown
    const headerToggle = document.querySelector('#header-lang-toggle');
    const langDropdown = document.querySelector('#lang-dropdown');
    const langOptions = langDropdown ? langDropdown.querySelectorAll('.lang-option') : [];

    // No need for click handlers since CSS hover handles the dropdown
    console.log('Language selector initialized');

    if (langOptions) {
        langOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const lang = this.dataset.lang;
                setLanguage(lang);
                console.log('Language option clicked:', lang);

                // Update active class
                langOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');

                // Update toggle button text
                const langToggleSpan = headerToggle.querySelector('span');
                if (langToggleSpan) {
                    langToggleSpan.textContent = this.textContent;
                }

                if (langDropdown.classList.contains('show')) {
                    langDropdown.classList.remove('show');
                }
                
                // animate globe
                if (globe) animateEarth();
                // sync language-bar buttons
                document.querySelectorAll('.language-bar .lang-btn').forEach(b => b.classList.remove('active'));
                const barBtn = document.querySelector('.language-bar .lang-btn[data-lang="' + lang + '"]');
                if (barBtn) barBtn.classList.add('active');
            });
        });
    }
});

// Animate number counting
function animateNumber(element, target) {
    let current = 0;
    const increment = target / 100;
    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            current = target;
            clearInterval(timer);
        }
        element.textContent = Math.floor(current);
    }, 20);
}

// Animate elements on scroll
function animateOnScroll() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    });
    
    document.querySelectorAll('.fade-in').forEach(el => {
        observer.observe(el);
    });
}

// Create ripple effect
function createRipple(event) {
    const button = event.currentTarget;
    const ripple = document.createElement('span');
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    ripple.classList.add('ripple');
    
    button.appendChild(ripple);
    
    setTimeout(() => {
        ripple.remove();
    }, 600);
}

// Handle form submission
function handleFormSubmission() {
    const formData = new FormData(contactForm);
    const submitBtn = contactForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    // Show loading state
    submitBtn.textContent = 'Sending...';
    submitBtn.disabled = true;
    
    // Simulate form submission
    setTimeout(() => {
        // Show success message
        showNotification('Message sent successfully!', 'success');
        
        // Reset form
        contactForm.reset();
        
        // Reset button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }, 2000);
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        background: ${type === 'success' ? '#4CAF50' : '#2196F3'};
        color: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Add scroll effects to navbar
// window.addEventListener('scroll', function() {
//     const navbar = document.querySelector('.navbar');
//     if (window.scrollY > 100) {
//         navbar.style.background = 'rgba(255, 255, 255, 0.98)';
//         navbar.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.15)';
//     } else {
//         navbar.style.background = 'rgba(255, 255, 255, 0.95)';
//         navbar.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
//     }
// });

// Add parallax effect to floating elements
window.addEventListener('scroll', function() {
    const scrolled = window.pageYOffset;
    const floatingIcons = document.querySelectorAll('.floating-icon');
    
    floatingIcons.forEach((icon, index) => {
        const speed = 0.5 + (index * 0.1);
        const yPos = -(scrolled * speed);
        icon.style.transform = `translateY(${yPos}px)`;
    });
});

// Add CSS for ripple effect
const style = document.createElement('style');
style.textContent = `
    .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: scale(0);
        animation: ripple-animation 0.6s linear;
        pointer-events: none;
    }
    
    @keyframes ripple-animation {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
    
    .notification {
        font-family: inherit;
        font-weight: 500;
    }
`;
document.head.appendChild(style);

// Add floating animation to product cards
document.querySelectorAll('.product-card').forEach((card, index) => {
    card.style.animationDelay = `${index * 0.2}s`;
    card.classList.add('fade-in');
});

// Add floating animation to service cards
document.querySelectorAll('.service-card').forEach((card, index) => {
    card.style.animationDelay = `${index * 0.2}s`;
    card.classList.add('fade-in');
});

// Add smooth reveal animation for sections
const revealSections = document.querySelectorAll('section');
const revealObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            // console.log("Animating section:", entry.target.id);
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
        }
    });
}, {
    threshold: 0.1
});

revealSections.forEach(section => {
    section.style.opacity = '0';
    section.style.transform = 'translateY(150px)';
    section.style.transition = 'all 1.5s ease';
    revealObserver.observe(section);
});

// Add typing effect to hero title
function typeWriter(element, text, speed = 100) {
    let i = 0;
    element.textContent = '';
    
    function type() {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            setTimeout(type, speed);
        }
    }
    
    type();
}

// Initialize typing effect when hero section is visible
const heroSection = document.querySelector('.hero');
const heroTitle = document.querySelector('.hero-title');

if (heroSection && heroTitle) {
    const heroObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const originalText = getTranslation('hero.title', currentLang);
                typeWriter(heroTitle, originalText, 50);
            }
        });
    }, {
        threshold: 0.5
    });

    heroObserver.observe(heroSection);
}

// Add scroll effects to navbar
window.addEventListener('scroll', function() {
    const header = document.querySelector('.top-header');
    if (window.scrollY > 50) {
        header.classList.add('scrolled');
    } else {
        header.classList.remove('scrolled');
    }
});

// Category filter
const categoryFilter = document.getElementById('category-filter');
if (categoryFilter) {
    categoryFilter.addEventListener('change', function() {
        const selectedCategory = this.value;
        // console.log('Selected category:', selectedCategory);
        // Add your product filtering logic here
    });
}

// Product Viewer Logic
document.addEventListener('DOMContentLoaded', function() {
    const categoryList = document.getElementById('category-list');
    const productGrid = document.getElementById('product-grid');
    const sortBy = document.getElementById('sort-by');

    let allProducts = [];
    let currentProducts = [];

    // 1. Populate Categories and Products
    if (typeof categoryData !== 'undefined' && categoryList) {
        // Create "All" category
        const allCategoryItem = document.createElement('li');
        const allCategoryLink = document.createElement('a');
        allCategoryLink.href = '#';
        allCategoryLink.textContent = 'All';
        allCategoryLink.classList.add('category-link', 'font-bold');
        allCategoryLink.dataset.category = 'all';
        allCategoryItem.appendChild(allCategoryLink);
        categoryList.appendChild(allCategoryItem);

        for (const category in categoryData) {
            const categoryItem = document.createElement('li');
            const categoryLink = document.createElement('a');
            categoryLink.href = '#';
            categoryLink.textContent = category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            categoryLink.classList.add('category-link');
            categoryLink.dataset.category = category;
            categoryItem.appendChild(categoryLink);
            categoryList.appendChild(categoryItem);

            categoryData[category].forEach(productName => {
                const productNameWithoutExt = productName.split('.').slice(0, -1).join('.');
                allProducts.push({
                    id: productNameWithoutExt, // Using name as ID for now
                    name: productNameWithoutExt,
                    image: `products/${productName}`,
                    category: category,
                    price: parseFloat((Math.random() * 100 + 10).toFixed(2)), // Placeholder random price
                    // Placeholder for date - using filename for now
                    date: productName 
                });
            });
        }
        // Remove duplicates
        allProducts = allProducts.filter((product, index, self) =>
            index === self.findIndex((p) => (
                p.name === product.name
            ))
        );
        currentProducts = [...allProducts];
        displayProducts(currentProducts);
    }

    // 2. Display Products
    function displayProducts(products) {
        if(!productGrid) return;
        productGrid.innerHTML = '';
        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.classList.add('product-card', 'border', 'rounded-lg', 'p-4', 'text-center');
            
            const productImage = document.createElement('img');
            productImage.src = product.image;
            productImage.alt = product.name;
            productImage.classList.add('w-full', 'h-48', 'object-cover', 'mb-2');

            const productName = document.createElement('h4');
            productName.textContent = product.name;
            productName.classList.add('font-semibold');

            productCard.appendChild(productImage);
            productCard.appendChild(productName);
            productGrid.appendChild(productCard);
        });
    }

    // 3. Category Filtering
    if(categoryList) {
        categoryList.addEventListener('click', function(e) {
            if (e.target.classList.contains('category-link')) {
                e.preventDefault();
                const selectedCategory = e.target.dataset.category;

                // highlight active category
                document.querySelectorAll('.category-link').forEach(link => link.classList.remove('font-bold'));
                e.target.classList.add('font-bold');

                if (selectedCategory === 'all') {
                    currentProducts = [...allProducts];
                } else {
                    currentProducts = allProducts.filter(product => product.category === selectedCategory);
                }
                sortAndDisplayProducts();
            }
        });
    }

    // 4. Sorting
    if(sortBy) {
        sortBy.addEventListener('change', sortAndDisplayProducts);
    }

    function sortAndDisplayProducts() {
        const sortByValue = sortBy.value;
        let sortedProducts = [...currentProducts];

        switch (sortByValue) {
            case 'az':
                sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'za':
                sortedProducts.sort((a, b) => b.name.localeCompare(a.name));
                break;
            case 'date-new':
                // Using filename as a proxy for date, newest first
                sortedProducts.sort((a, b) => b.date.localeCompare(b.date));
                break;
            case 'date-old':
                // Using filename as a proxy for date, oldest first
                sortedProducts.sort((a, b) => a.date.localeCompare(b.date));
                break;
        }
        displayProducts(sortedProducts);
    }

    // 5. Price Filter (Placeholder)
    const priceFilter = document.getElementById('price-filter');
    if(priceFilter) {
        priceFilter.addEventListener('input', function() {
            // NOTE: Price data is not available for products.
            // This is a placeholder and does not filter products.
            // console.log('Price filter changed to:', this.value);
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('retail-products')) {
        const productsGrid = document.getElementById('products-grid');
        const categorySelect = document.getElementById('category-select');

        if(productsGrid && categorySelect) {
            // Get unique categories
            const categories = [...new Set(products.map(p => p.category))];

            // Populate category filter
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            // Function to display products
            function displayProducts(filteredProducts) {
                productsGrid.innerHTML = '';
                filteredProducts.forEach(product => {
                    const productCard = `
                        <div class="product-card">
                            <img src="${product.image}" alt="${product.name}" class="product-image">
                            <div class="product-content">
                                <h3 class="product-title">${product.name}</h3>
                                <p class="product-category">${product.category}</p>
                                <p class="product-description">${product.description}</p>
                            </div>
                        </div>
                    `;
                    productsGrid.innerHTML += productCard;
                });
            }

            // Initial display of all products
            displayProducts(products);

            // Filter products when category changes
            categorySelect.addEventListener('change', function() {
                const selectedCategory = this.value;
                if (selectedCategory === 'all') {
                    displayProducts(products);
    } else {
                    const filteredProducts = products.filter(p => p.category === selectedCategory);
                    displayProducts(filteredProducts);
                }
            });
        }
    }
});

// ==== Retail products viewer (retail.html) ====
(function(){
	const container = document.querySelector('#retail-products .container');
	if(!container) return; // only on retail page

	// Build wrapper
	const wrapper = document.createElement('div');
	wrapper.className = 'retail-products-wrapper';

	// Sidebar filters
	const filters = document.createElement('aside');
	filters.className = 'filters';
	filters.innerHTML = `
		<div class="filters-header">
			<span>Filters</span>
			<button type="button" class="btn-reset" aria-label="Reset">Reset</button>
		</div>
		<div>
			<label>Category</label>
			<div class="chip-group" id="chip-group"></div>
		</div>
		<div>
			<label>Price range</label>
			<div class="range-row">
				<input type="number" class="input" id="minPrice" placeholder="0" min="0">
				<input type="number" class="input" id="maxPrice" placeholder="500" min="0">
			</div>
		</div>
		<div class="checkbox-row">
			<input type="checkbox" id="inStock"> <label for="inStock">In stock only</label>
		</div>
		<button class="apply-btn" id="applyFilters">Apply filters</button>
	`;

	// Main column
	const main = document.createElement('div');
	main.innerHTML = `
		<h2 class="category-headline">Retail Products</h2>
		<div class="products-toolbar">
			<div class="toolbar-left">
				<a href="retail.html" class="btn btn-primary">Back to Retail</a>
			</div>
			<div class="toolbar-center">
				<span id="itemCount"></span>
			</div>
			<div class="toolbar-right">
				<div class="view-toggle" role="tablist">
					<button class="toggle btn btn-secondary active" data-view="grid">Grid</button>
					<button class="toggle btn btn-secondary" data-view="list">List</button>
				</div>
			</div>
		</div>
		<div id="viewerGrid" class="products-grid viewer"></div>
	`;

	wrapper.appendChild(filters);
	wrapper.appendChild(main);
	container.appendChild(wrapper);

	// Data
	const categories = window.RT_CATEGORIES || [];
	const products = window.RT_PRODUCTS || [];
	
	// Populate category chips
	const chipGroup = filters.querySelector('#chip-group');
	let activeCategory = 'all';
	function renderChips(){
		chipGroup.innerHTML = '';
		const allChip = createChip('all', 'All');
		chipGroup.appendChild(allChip);
		categories.forEach(c => chipGroup.appendChild(createChip(c.id, c.name)));
		updateActiveChip();
	}
	function createChip(id, label){
		const b = document.createElement('button');
		b.type = 'button';
		b.className = 'chip';
		b.dataset.id = id;
		b.textContent = label;
		b.addEventListener('click', ()=>{ activeCategory = id; updateActiveChip(); renderProducts(); });
		return b;
	}
	function updateActiveChip(){
		chipGroup.querySelectorAll('.chip').forEach(ch => ch.classList.toggle('active', ch.dataset.id === activeCategory));
	}

	// Render products
	const grid = main.querySelector('#viewerGrid');
	let currentView = 'grid';
	function renderProducts(){
		const min = parseFloat(filters.querySelector('#minPrice').value) || 0;
		const max = parseFloat(filters.querySelector('#maxPrice').value) || Number.POSITIVE_INFINITY;
		const filtered = products.filter(p => {
			const numericPrice = parseFloat(String(p.price).replace(/[^0-9.]/g, ''));
			return (activeCategory==='all' || p.category===activeCategory) && numericPrice>=min && numericPrice<=max;
		});
		grid.className = currentView === 'grid' ? 'products-grid viewer' : 'products-grid viewer list-view';
		grid.innerHTML = filtered.map(p => cardHtml(p)).join('');
		main.querySelector('#itemCount').textContent = `${filtered.length} items`;
	}
	function stars(r){
		const full = Math.floor(r);
		const half = r - full >= 0.5;
		return '★'.repeat(full) + (half?'½':'') + '☆'.repeat(5-full-(half?1:0));
	}
	function badgeRow(badges){
		if(!badges || !badges.length) return '';
		return `<div class="badge-row">${badges.map(b=>`<span class="badge ${b.toLowerCase()==='out'?'out':''}">${b}</span>`).join('')}</div>`;
	}
	function cardHtml(p){
		const numericPrice = parseFloat(String(p.price).replace(/[^0-9.]/g, ''));
		const imagePath = String(p.image).startsWith('products/') ? p.image : 'products/' + p.image;

		return `
			<div class="product-card viewer">
				<div class="product-media" role="img" aria-label="${p.name}">
					${badgeRow(p.badges)}
					<img src="${imagePath}" alt="${p.name}" style="width:70%;height:100px;object-fit:contain;"/>
				</div>
				<div class="product-body">
					<div style="display:flex;align-items:center;gap:.5rem">
						<div class="product-title">${p.name}</div>
						<div class="price">QAR ${numericPrice.toFixed(2)}</div>
					</div>
					<div class="meta"><span class="stars">★★★★★</span><span>(${p.reviews || 0})</span></div>
					<div class="product-actions">
						<button class="btn-ghost">Quick view</button>
						<button class="btn-primary add-to-basket" 
                                data-product-id="${p.id}" 
                                data-product-name="${p.name}" 
                                data-product-price="${numericPrice}" 
                                data-product-image="${imagePath}">
                            Add to Basket
                        </button>
					</div>
				</div>
			</div>`;
	}

	// View toggles
	main.querySelectorAll('.view-toggle .toggle').forEach(btn=>{
		btn.addEventListener('click', ()=>{
			main.querySelectorAll('.view-toggle .toggle').forEach(b=>b.classList.remove('active'));
			btn.classList.add('active');
			currentView = btn.dataset.view;
			renderProducts();
		});
	});

	filters.querySelector('#applyFilters').addEventListener('click', renderProducts);
	filters.querySelector('.btn-reset').addEventListener('click', ()=>{
		filters.querySelector('#minPrice').value = '';
		filters.querySelector('#maxPrice').value = '';
		activeCategory = 'all';
		updateActiveChip();
		renderProducts();
	});

	renderChips();
	renderProducts();
})();

// Enhance retail viewer: searchable category selector (disabled per request)
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	// Selector removed — keep products toolbar without search box
	return;
	// (previous implementation intentionally disabled)
})();

// Retail: disable sidebar filters when using searchable selector only
(function(){
	const container = document.querySelector('#retail-products .container');
	if(!container) return;
	// After viewer init
	window.addEventListener('load', ()=>{
		const wrapper = container.querySelector('.retail-products-wrapper');
		const filters = container.querySelector('.filters');
		if(wrapper && filters){
			wrapper.classList.add('no-filters');
			filters.setAttribute('aria-hidden','true');
		}
	});
})();

// Retail: render categories as product viewer tiles (legacy placement) — active when selector is removed
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	window.addEventListener('load', ()=>{
		// If the searchable selector exists, a newer block would handle category placement; here it does not.
		const mainGrid = retailContainer.querySelector('#viewerGrid');
		const filters = retailContainer.querySelector('.filters');
		const chipGroup = filters ? filters.querySelector('#chip-group') : null;
		const categories = window.RT_CATEGORIES || [];
		if(!mainGrid || categories.length === 0) return;

		const catsWrap = document.createElement('div');
		catsWrap.className = 'viewer-categories';

		// thumbnail mapping (add real images under assets/ as needed)
		const imgMap = {
			'air-fryer-paper-products': 'assets/cat-generic.png',
			'aluminum-container-products': 'assets/cat-generic.png',
			'aluminum-foil-products': 'assets/cat-generic.png',
			'aluminum-plate-products': 'assets/cat-generic.png',
			'aluminum-pot-with-hood-products': 'assets/cat-generic.png',
			'baking-and-cooking-products': 'assets/cat-generic.png',
			'body-soap': 'assets/cat-generic.png',
			'carpets-mates-products': 'assets/cat-generic.png',
			'clear-tape-products': 'assets/cat-generic.png',
			'cling-film-products': 'assets/cat-generic.png',
			'cotton-products': 'assets/cat-generic.png',
			'crystal-plates-products': 'assets/cat-generic.png',
			'cup-cake-products': 'assets/cat-generic.png',
			'dish-washer-products': 'assets/cat-generic.png',
			'dish-washing-products': 'assets/cat-generic.png',
			'disposal-plastic-and-paper-plates-products': 'assets/cat-generic.png',
			'electronic-devices': 'assets/cat-mobiles.png',
			'food-bag-products': 'assets/cat-generic.png',
			'hair-remover': 'assets/cat-generic.png',
			'jumbo-table-sheet-ld': 'assets/cat-generic.png',
			'kitchen-products': 'assets/cat-appliances.png',
			'loofah-products': 'assets/cat-generic.png',
			'maxi-roll-products': 'assets/cat-generic.png',
			'paper-cup-products': 'assets/cat-generic.png',
			'shoe-shine': 'assets/cat-generic.png',
			'straw': 'assets/cat-generic.png',
			'sugar-products': 'assets/cat-generic.png',
			'table-sheet-products': 'assets/cat-generic.png',
			'tissue-products': 'assets/cat-generic.png',
			'towel-products': 'assets/cat-generic.png'
		};

		catsWrap.innerHTML = categories.map((c)=>{
			const src = imgMap[c.id] || 'assets/cat-generic.png';
			return `<a href="${c.id}.html" class="cat-card" data-id="${c.id}">
				<div class="cat-thumb"><img src="${src}" alt="${c.name}" onerror="this.src='assets/cat-generic.png'"/></div>
				<div class="cat-name">${c.name}</div>
			</a>`;
		}).join('');

		mainGrid.parentElement.prepend(catsWrap);

		// Category cards are now links, no need for click handler
	});
})();

// Retail: add Grid/List buttons above categories
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	window.addEventListener('load', ()=>{
		const catsWrap = retailContainer.querySelector('.viewer-categories');
		if(!catsWrap) return;
		let toolbar = retailContainer.querySelector('.cat-toolbar');
		if(!toolbar){
			toolbar = document.createElement('div');
			toolbar.className = 'cat-toolbar';
			toolbar.innerHTML = `
				<div style="font-weight:700;color:var(--secondary,#182352)">Categories</div>
				<div class="view-toggle" aria-label="Categories view">
					<button class="toggle active" data-view="grid">Grid</button>
					<button class="toggle" data-view="list">List</button>
				</div>
			`;
			catsWrap.parentElement.insertBefore(toolbar, catsWrap);
		}
		const toggles = retailContainer.querySelectorAll('.cat-toolbar .toggle');
		function apply(){
			const active = retailContainer.querySelector('.cat-toolbar .toggle.active')?.dataset.view || 'grid';
			catsWrap.classList.toggle('list', active==='list');
		}
		toggles.forEach(btn=>btn.addEventListener('click', ()=>{
			toggles.forEach(b=>b.classList.remove('active'));
			btn.classList.add('active');
			apply();
		}));
		apply();
	});
})();

// Retail: move categories under search selector and toggle list/grid (no-op when selector removed)
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	window.addEventListener('load', ()=>{
		const selectWrap = retailContainer.querySelector('.select-search');
		if(!selectWrap){
			// Ensure any categories wrapper is visible when no selector exists
			const cats = retailContainer.querySelector('.viewer-categories');
			if(cats) cats.classList.remove('hidden');
			return;
		}
	});
})();

// Retail: toggle categories visibility with selector (no selector => ensure visible)
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	window.addEventListener('load', ()=>{
		const selectWrap = retailContainer.querySelector('.select-search');
		let catsWrap = retailContainer.querySelector('.viewer-categories');
		if(!catsWrap) return;
		if(!selectWrap){ catsWrap.classList.remove('hidden'); return; }
		catsWrap.classList.add('hidden');
		const input = selectWrap.querySelector('.select-search-input');
		const open = ()=>{ selectWrap.classList.add('open'); catsWrap.classList.remove('hidden'); };
		const close = ()=>{ selectWrap.classList.remove('open'); catsWrap.classList.add('hidden'); };
		input.addEventListener('focus', open);
		input.addEventListener('input', open);
		document.addEventListener('click', (e)=>{ if(!selectWrap.contains(e.target) && !catsWrap.contains(e.target)) close(); });
	});
})();

// Retail: temporarily hide content below categories per request
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	window.addEventListener('load', ()=>{
		const grid = retailContainer.querySelector('#viewerGrid');
		if(grid){ grid.classList.add('hidden'); }
	});
})();

// Retail: remove products toolbar per request
(function(){
	const c = document.querySelector('#retail-products .container');
	if(!c) return;
	window.addEventListener('load', ()=>{
		const tb = c.querySelector('.products-toolbar');
		if(tb) tb.remove();
	});
})();

// Helper: resolve category thumbnail from product sources (categoryData or RT_PRODUCTS)
function __resolveCategoryThumb(category) {
	try {
		const norm = (s)=> String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
		const cname = norm(category.name || category.id);

		// 1) Look into categoryData mapping: { key: ["file1.jpg", ...] }
		const data = (window.categoryData) ? window.categoryData : null;
		if (data) {
			const keys = Object.keys(data);
			let matchKey = keys.find(k => norm(k) === cname) || keys.find(k => cname.includes(norm(k)) || norm(k).includes(cname));
			if (matchKey) {
				const files = Array.isArray(data[matchKey]) ? data[matchKey] : [];
				if (files.length) {
					const f = String(files[0]);
					return f.startsWith('http') || f.startsWith('data:') ? f : (f.startsWith('products/') ? f : 'products/' + f);
				}
			}
		}

		// 2) Fall back to RT_PRODUCTS list with { category, image|img }
		const list = Array.isArray(window.RT_PRODUCTS) ? window.RT_PRODUCTS : [];
		if (list.length) {
			const pick = list.find(p => norm(p.category) === cname || norm(p.category).includes(cname) || cname.includes(norm(p.category)));
			if (pick) {
				const img = pick.image || pick.img || '';
				if (img) {
					return img.startsWith('http') || img.startsWith('data:') ? img : (img.startsWith('products/') ? img : 'products/' + img);
				}
			}
		}
		return null;
	} catch (e) { return null; }
}

// Apply product-based thumbnails to categories
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	window.addEventListener('load', ()=>{
		const catsWrap = retailContainer.querySelector('.viewer-categories');
		if(!catsWrap) return;
		const categories = window.RT_CATEGORIES || [];
		catsWrap.querySelectorAll('.cat-card').forEach((card, idx)=>{
			const id = card.dataset.id;
			const cat = categories.find(c=>c.id===id) || { id, name: card.querySelector('.cat-name')?.textContent || id };
			const src = __resolveCategoryThumb(cat);
			if (src) {
				let thumb = card.querySelector('.cat-thumb');
				if (!thumb) {
					thumb = document.createElement('div');
					thumb.className = 'cat-thumb';
					card.insertBefore(thumb, card.firstChild);
				}
				thumb.innerHTML = `<img src="${src}" alt="${cat.name}">`;
			}
		});
	});
})();

// Utility: try a list of image URLs and resolve with the first that actually loads
function __loadFirstAvailableImage(urls, onSuccess, onFail){
	if(!urls || !urls.length){ onFail && onFail(); return; }
	let idx = 0;
	const img = new Image();
	img.referrerPolicy = 'no-referrer';
	img.onload = ()=> onSuccess && onSuccess(urls[idx]);
	img.onerror = ()=>{ idx++; if(idx < urls.length){ img.src = urls[idx]; } else { onFail && onFail(); } };
	img.src = urls[idx];
}

// Apply local products/ images to category tiles by name/id guessing
(function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	window.addEventListener('load', ()=>{
		const catsWrap = retailContainer.querySelector('.viewer-categories');
		if(!catsWrap) return;
		const categories = window.RT_CATEGORIES || [];
		const norm = (s)=> String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$|--+/g,'');
		catsWrap.querySelectorAll('.cat-card').forEach(card=>{
			const id = card.dataset.id;
			const cat = categories.find(c=>c.id===id) || { id, name: id };
			const pretty = norm(cat.name);
			const candidates = [
				`products/${id}.jpg`, `products/${id}.png`, `products/${id}.jpeg`, `products/${id}.webp`,
				`products/${pretty}.jpg`, `products/${pretty}.png`, `products/${pretty}.jpeg`, `products/${pretty}.webp`
			];
			const placeholder = 'assets/cat-generic.png';
			let thumb = card.querySelector('.cat-thumb');
			if(!thumb){ thumb = document.createElement('div'); thumb.className = 'cat-thumb'; card.insertBefore(thumb, card.firstChild); }
			const existingImg = thumb.querySelector('img');
			if(existingImg && existingImg.getAttribute('src') && !existingImg.getAttribute('src').includes('cat-generic')){
				// already set via categoryData/RT_PRODUCTS
				return;
			}
			__loadFirstAvailableImage(candidates, (src)=>{
				thumb.innerHTML = `<img src="${src}" alt="${cat.name}">`;
			}, ()=>{
				// leave placeholder or previously set image
				if(!existingImg){ thumb.innerHTML = `<img src="${placeholder}" alt="${cat.name}">`; }
			});
		});
	});
})();

// Optional: load products/manifest.json mapping { "category-id or name": "relative/path.jpg" }
(async function(){
	const retailContainer = document.querySelector('#retail-products .container');
	if(!retailContainer) return;
	try {
		const res = await fetch('products/manifest.json', { cache: 'no-store' });
		if(!res.ok) return;
		const mapping = await res.json();
		if(!mapping) return;
		const catsWrap = retailContainer.querySelector('.viewer-categories');
		if(!catsWrap) return;
		const categories = window.RT_CATEGORIES || [];
		const norm = (s)=> String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
		catsWrap.querySelectorAll('.cat-card').forEach(card=>{
			const id = card.dataset.id;
			const cat = categories.find(c=>c.id===id) || { id, name: id };
			const candidates = [];
			Object.entries(mapping).forEach(([k,v])=>{
				if(norm(k)===norm(cat.id) || norm(k)===norm(cat.name)){
					candidates.push(String(v));
				}
			});
			if(!candidates.length) return;
			let thumb = card.querySelector('.cat-thumb');
			if(!thumb){ thumb = document.createElement('div'); thumb.className='cat-thumb'; card.insertBefore(thumb, card.firstChild); }
			const src = candidates[0];
			thumb.innerHTML = `<img src="${src.startsWith('products/')?src:('products/'+src)}" alt="${cat.name}">`;
		});
	} catch(e){ /* silent if manifest missing */ }
})();

// Admin access key combination (Ctrl + Shift + A)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        const adminLink = document.querySelector('.admin-link');
        if (adminLink) {
            adminLink.style.display = adminLink.style.display === 'none' ? 'flex' : 'none';
        }
    }
});